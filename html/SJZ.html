<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>建立半透明的模型地图，在地图中嵌入立方体和圆柱体的要点，并用贴合地面（？）的路径连接要点</title>
    <style>
        html, body {
            overflow: hidden;
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
        }
        #renderCanvas {
            width: 100%;
            height: 70%;
            touch-action: none;
        }
        #fps {    position: absolute;    right: 20px;    top: 5em;    font-size: 20px;    color: white;/*帧数显示*/
            text-shadow: 2px 2px 0 black;}
        #div_bottom div{
            position: absolute;
        }
        .div_btn{
            font-size: 20px;line-height: 20px;position: absolute;cursor:crosshair;
        }
        .div_htmlmesh{
            font-size: 100%;line-height: 100%;position: absolute;border:1px solid;top:-50%;left:-50%
        }
        .mod_group,.mod_unit{
            font-size: 100%;line-height: 100%;position: absolute;
        }
    </style>
    <script src="./lib/bbl8b/babylon.js"></script>
    <script src="./lib/bbl8b/babylon.inspector.bundle.js"></script>
    <script src="./lib/bbl8b/babylon.gui.min.js"></script>
    <script src="./lib/newland.js"></script>
    <script src="./lib/nohurry.js"></script>
    <script src="./lib/VTools.js"></script>
    <!--<script src="./lib/sqliteClient.js"></script>-->
    <script src="./lib/computeResource.js"></script>
    <script src="./lib/ControlQX5.js"></script>
    <script src="./lib/drawStellaris6.js"></script>
    <script src="./lib/drawSprites.js"></script>
    <script src="./lib/drawGalaxy6.js"></script>
    <script src="./lib/drawStar.js"></script>
    <script src="./lib/drawPlanet.js"></script>
</head>
<body>
    <canvas id="renderCanvas" touch-action="none"></canvas>
    <div id="fps" style="z-index: 302;"></div>
    <div id="div_bottom" style="z-index: 301;position: absolute;bottom: 0px;width: 100%;height: 30%;font-size: 12px;border-top: 1px solid">

    </div>
    <div id="div_comment" style="z-index: 302;position:fixed;display: none;width: 200px;height: 400px;left: 0px;bottom:0px;border: 1px solid black">
    </div>
    <div id="btn_comment" style="z-index: 303;position:fixed;display: block;width: 20px;height: 80px;left: 0px;bottom:150px;text-align: center;
            background-color:gainsboro;cursor: pointer;border: 1px solid black"
         onclick="showComment()">提<br/>示<br/>》
    </div>
    <div id="div_hidden" style="display: none">

    </div>
</body>
<script>
    //@@@@接下来要连接航道，并且用带遮罩的相机绘制外层空间的天空盒 console.log("开始全局初始化！");
    console.log(new Date().getTime());
    var flag_comment=false;
    var div_comment=document.getElementById("div_comment");
    var btn_comment=document.getElementById("btn_comment");
    function showComment()
    {
        if(!flag_comment)
        {
            div_comment.style.display="block";
            btn_comment.style.left="201px";
            btn_comment.innerHTML="提<br/>示<br/>《";
        }
        else {
            div_comment.style.display="none";
            btn_comment.style.left="0px";
            btn_comment.innerHTML="提<br/>示<br/>》";
        }
        flag_comment=!flag_comment;
    }

    var flag_runningstate="等待场景初始化";
    var VERSION=1.0,AUTHOR="1113908055@qq.com";
    var machine,canvas,engine,scene,gl,MyGame,camera0,camera_minimap,experience;
    var camera_x,camera_x2,camera_y,camera_y2,camera_z,camera_z2;//用来生成即时天空盒
    machine=navigator;
    canvas = document.getElementById("renderCanvas");
    var div_bottom=document.getElementById("div_bottom");
    var divFps = document.getElementById("fps");
    var div_hidden= document.getElementById("div_hidden");
    var flag_webgpu=true;

    var one=null;//如果有第一人称或第三人称控制的核心对象
    var int_z=0;//这个值越大代表距离越近，显示的svg细节越仔细，规定在小于-2时减少显示细节
    var int0=1,int0b=1;
    var divFps = document.getElementById("fps");
    window.onload=beforewebGL;
    async function beforewebGL()
    {
        try{
            //throw null;
            engine = new BABYLON.WebGPUEngine(canvas,{ stencil: true ,setMaximumLimits:true});
            await engine.initAsync();
            engine.snapshotRenderingMode = BABYLON.Constants.SNAPSHOTRENDERING_FAST;
        }catch(e)
        {
            console.log("不支持WebGPU，改用WebGL渲染模式");
            flag_webgpu=false;
            engine=new BABYLON.Engine(canvas, true, { preserveDrawingBuffer: true, stencil: true,  disableWebGL2Support: false});

        }
        scene = new BABYLON.Scene(engine);
        //初始化Sqlite worker
        //initSqlite(Init)
        Init();
    }
    async function Init()
    {
        await initScene();
        await initArena();
        //initGuiControl();
        //initStars();
        InitMouse();
        initSkybox(webGLStart2);
        //webGLStart2();
    }
    var mat_global={},hd_camera0=Math.PI/2;;
    async function initScene()
    {
        //scene.clearColor=new BABYLON.Color3(0,0,0);
        var light0 = new BABYLON.HemisphericLight("light0", new BABYLON.Vector3(0, 1, 0), scene);
        light0.diffuse = new BABYLON.Color3(1,1,1);//这道“颜色”是从上向下的，底部收到100%，侧方收到50%，顶部没有
        light0.specular = new BABYLON.Color3(0,0,0);
        light0.groundColor = new BABYLON.Color3(1,1,1);//这个与第一道正相反

        camera0= new BABYLON.UniversalCamera("FreeCamera", new BABYLON.Vector3(0, 600, 0), scene);
        camera0.rotation.x=hd_camera0;//需要45度斜向下视角
        camera0.maxZ=20000;
        camera0.minZ=0.1;
        //scene.activeCameras.push(camera0);
        camera0.speed=1;
        camera0.myRotation={x:0,y:0,z:0};
        var node_hand=new BABYLON.TransformNode("hand");
        node_hand.position.z=1;
        node_hand.parent=camera0;
        camera0.node_hand=node_hand;
        var node_pick=new BABYLON.TransformNode("pick");
        node_pick.position.z=100;
        node_pick.parent=camera0;
        camera0.node_pick=node_pick;
        scene.activeCameras = [camera0];
        var mat_green=new BABYLON.StandardMaterial("mat_green", scene);
        mat_green.diffuseColor = new BABYLON.Color3(0, 1, 0);
        mat_green.freeze();
        mat_global.mat_green=mat_green;
        var mat_frame=new BABYLON.StandardMaterial("mat_frame", scene);
        mat_frame.wireframe=true;
        mat_frame.freeze();
        mat_global.mat_frame=mat_frame;
        var mat_white_e=new BABYLON.StandardMaterial("mat_white_e", scene);
        mat_white_e.disableLighting = true;
        mat_white_e.emissiveColor = BABYLON.Color3.White();
        mat_white_e.freeze();
        mat_global.mat_white_e=mat_white_e;
    }
    var skybox;
    var class_box;
    async function initArena()
    {
        //三个参照物
        // var mesh_base=new BABYLON.MeshBuilder.CreateSphere("mesh_base",{diameter:1},scene);
        // mesh_base.material=mat_global.mat_green;
        // mesh_base.position.x=0;
        // mesh_base.renderingGroupId=3;
        // window.mesh_base=mesh_base;
        // mesh_base.layerMask=1;
        // var mesh_base1=new BABYLON.MeshBuilder.CreateSphere("mesh_base1",{diameter:1},scene);
        // mesh_base1.position.y=10;
        // mesh_base1.position.x=0;
        // mesh_base1.material=mat_global.mat_green;
        // mesh_base1.renderingGroupId=3;
        // mesh_base1.layerMask=1;
        // var mesh_base2=new BABYLON.MeshBuilder.CreateSphere("mesh_base2",{diameter:1},scene);
        // mesh_base2.position.y=-10;
        // mesh_base2.position.x=0;
        // mesh_base2.material=mat_global.mat_green;
        // mesh_base2.renderingGroupId=3;
        // mesh_base2.layerMask=1;
        // mesh_base.alwaysSelectAsActiveMesh=true;
        // mesh_base1.alwaysSelectAsActiveMesh=true;
        // mesh_base2.alwaysSelectAsActiveMesh=true;

        class_box = BABYLON.BoxBuilder.CreateBox("class_box", {size: 1,updatable:true});
        class_box.alwaysSelectAsActiveMesh = true;
        class_box.renderingGroupId=2;
        class_box.material = mat_global.mat_white_e;
        class_box.isPickable = true;
        class_box.thinInstanceEnablePicking = true;

    }
    function webGLStart2()
    {
        flag_runningstate="场景初始化完成";
        sr_global= new BABYLON.SnapshotRenderingHelper(scene);
        createManagers();

        //scene.debugLayer.show();
        initStellaris();
        MyBeforeRender0();
        //scene.debugLayer.show();
    }

</script>
</html>