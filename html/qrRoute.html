<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>基于二维码的路由页面</title>
    <style>
        html, body {
            overflow: hidden;
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
        }
        .div_qr{
            width: 256px;
            height: 256px;
        }
    </style>
    <script src="lib/qrcode.min.js"></script>
    <script src="config.js"></script>
</head>
<body>
    <div id="div_allbase">
        <span>已有用户列表：</span><div id="div_userlist"></div>
        <span>新用户名：</span><input id="input_username" value="aaa">
    </div>
    <div id="div_hidden" style="display: none">
        <div class="div_qrcanvas">
            <!--<canvas width="256" height="256"></canvas>-->
            <div class="div_qr"></div>
            <div class="div_comment"></div>
        </div>
    </div>
</body>
<script>
    var div_allbase=document.getElementById("div_allbase");
    var div_userlist=document.getElementById("div_userlist");
    var input_username=document.getElementById("input_username");
    var div_qrcanvas=document.getElementById("div_hidden").getElementsByClassName("div_qrcanvas")[0];
    //createQRCode('./TestWS.html','ws测试页面');
    //var count=0;
    var qrcode1,qrcode2;
    var ws;
    var wsConnected=false;
    var userId='admin';
    var str_url="http://"+localIP+":"+httpPort;
    window.onload=function(){

        //qrcode1=createQRCode('./qrRoute.html','二维码导航页面');
        qrcode2=createQRCode(str_url+'/addUser.html#'+input_username.value,'添加新用户:',function(qrcode){
            //浏览器并不知道自己的二维码被扫描，它需要接收服务端的通知！

            //count++;

        });
        //initWS();

    }
    input_username.onchange=function(){
        var str_url2=str_url+'/addUser.html#'+input_username.value;
        qrcode2.makeCode(str_url2);
        qrcode2.div_comment.innerHTML='添加新用户:'+str_url2;
    }
    function initWS()
    {
        ws=new WebSocket("ws://"+localIP+":"+wsPort);
        ws.onopen = function (e) {
            console.log('Connection to server opened');
            //@@@@这里应该到admin去获取初始化信息以及自身在ws中的通道id，获取成功后才算连接完成！！！！
            wsConnected = true;
        }
        ws.onclose = function(e) {
            // 可以在 onclose 和 onerror 中处理重连的逻辑，再决定是否将状态更新为未连接状态
            wsConnected = false;
        }

        ws.onerror = function(e) {
            wsConnected = false;
        }
        ws.onmessage = function(e) {
            var msg = JSON.parse(e.data);
            switch(msg.type) {
                case "addUser":
                {
                    var userId2=msg.userId;
                    logWs("admin:"+userId2+"加入");
                    div_userlist.innerHTML+=(userId2+"|");
                    count=parseInt(userId2.split("-")[1])+1;
                    qrcode2.makeCode('./addUser.html#user'+count);//建立下一个用户！
                    qrcode2.div_comment='添加新用户'+count;
                }
                case "talk2EveryOne":
                {
                    var userId=msg.userId;
                    logWs(userId+":"+msg.data)
                }
            }
        }
    }
    function logWs(message)
    {
        console.log(message);
    }
    function createQRCode(str_url,str_comment,callback)
    {
        //var qr = qrcode(0, 'L'); // 0表示自动选择纠错等级和模式
        //qr.addData(str_url); // 添加数据
        //qr.make(); // 生成二维码

        var div_qrcanvas2=div_qrcanvas.cloneNode(true);
        div_allbase.appendChild(div_qrcanvas2);
        //var canvas=div_qrcanvas2.getElementsByTagName("canvas")[0];

        //var img = this; // 获取图片元素
        //var ctx = canvas.getContext('2d'); // 获取2D渲染上下文
        //ctx.drawImage(img, 0, 0, img.width, img.height); // 将图片绘制到canvas上
        //requestAnimationFrame(function(){
            var divs=div_qrcanvas2.getElementsByTagName("div");
            var qrcode = new QRCode(divs[0], {
                width : 256,
                height : 256
            });
            qrcode.makeCode(str_url);
            var div_comment=divs[1];
            div_comment.innerHTML=str_comment+str_url;
        qrcode.div_comment=div_comment;
            if(callback)
            {
                callback(qrcode);
            }

        //})
        return qrcode;
    }

</script>
</html>